(function() {
	var USER = {
		"name":"gezzoo_1",
		"token":"52728fbf63a64c904c657ed5",
		"id":"52728fbf63a64c904c657ed5"
	};

	var GAMES = [{
		"_id":"5286e01d9beb41000000001c",
		"me":{
			"username":"gezzoo_1",
			"_id":"52728fbf63a64c904c657ed5",
			"board":[
				{"_id":"5386e01d8b587b0000000001","up":true},
				{"_id":"5486e01d8b587b0000000001","up":true},
				{"_id":"5586e01d8b587b0000000001","up":true},
				{"_id":"5686e01d8b587b0000000001","up":true},
				{"_id":"5786e01d8b587b0000000001","up":true},
				{"_id":"5886e01d8b587b0000000001","up":true},
				{"_id":"5986e01d8b587b0000000001","up":true},
				{"_id":"5a86e01d8b587b0000000001","up":true},
				{"_id":"5b86e01d8b587b0000000001","up":true},
				{"_id":"5c86e01d8b587b0000000001","up":true},
				{"_id":"5d86e01d8b587b0000000001","up":true},
				{"_id":"5e86e01d8b587b0000000001","up":true},
				{"_id":"5f86e01d8b587b0000000001","up":true},
				{"_id":"5316e01d8b587b0000000001","up":true},
				{"_id":"5326e01d8b587b0000000001","up":true},
				{"_id":"5336e01d8b587b0000000001","up":true},
				{"_id":"5346e01d8b587b0000000001","up":true},
				{"_id":"5356e01d8b587b0000000001","up":true},
				{"_id":"5366e01d8b587b0000000001","up":true},
				{"_id":"5376e01d8b587b0000000001","up":true},
				{"_id":"5386e01d8b587b0000000002","up":true},
				{"_id":"5396e01d8b587b0000000002","up":true},
				{"_id":"53a6e01d8b587b0000000001","up":true},
				{"_id":"53b6e01d8b587b0000000001","up":true}
			],
			"character":"5486e01d8b587b0000000001"
		},
		"opponent":{
			"username":"gezzoo_0",
			"_id":"52728ca9954deb0b31000004"
		},
		"board":{
			"_id":"5286fd942200ab0000000002",
			"name":"Bollywood",
			"characters":[
				"5386e01d8b587b0000000001",
				"5486e01d8b587b0000000001",
				"5586e01d8b587b0000000001",
				"5686e01d8b587b0000000001",
				"5786e01d8b587b0000000001",
				"5886e01d8b587b0000000001",
				"5986e01d8b587b0000000001",
				"5a86e01d8b587b0000000001",
				"5b86e01d8b587b0000000001",
				"5c86e01d8b587b0000000001",
				"5d86e01d8b587b0000000001",
				"5e86e01d8b587b0000000001",
				"5f86e01d8b587b0000000001",
				"5316e01d8b587b0000000001",
				"5326e01d8b587b0000000001",
				"5336e01d8b587b0000000001",
				"5346e01d8b587b0000000001",
				"5356e01d8b587b0000000001",
				"5366e01d8b587b0000000001",
				"5376e01d8b587b0000000001",
				"5386e01d8b587b0000000002",
				"5396e01d8b587b0000000002",
				"53a6e01d8b587b0000000001",
				"53b6e01d8b587b0000000001"
			]
		},
		"turn":"52728ca9954deb0b31000004",
		"ended":false,
		"modified":"2014-01-15T00:42:42.997Z"
	},
	{
		"_id":"5286e01d9beb41000b00003a",
		"me":{
			"username":"gezzoo_1",
			"_id":"52728fbf63a64c904c657ed5",
			"board":[
				{"_id":"5386e01d8b587b0000000001","up":true},
				{"_id":"5486e01d8b587b0000000001","up":true},
				{"_id":"5586e01d8b587b0000000001","up":true},
				{"_id":"5686e01d8b587b0000000001","up":true},
				{"_id":"5786e01d8b587b0000000001","up":true},
				{"_id":"5886e01d8b587b0000000001","up":true},
				{"_id":"5986e01d8b587b0000000001","up":true},
				{"_id":"5a86e01d8b587b0000000001","up":true},
				{"_id":"5b86e01d8b587b0000000001","up":true},
				{"_id":"5c86e01d8b587b0000000001","up":true},
				{"_id":"5d86e01d8b587b0000000001","up":true},
				{"_id":"5e86e01d8b587b0000000001","up":true},
				{"_id":"5f86e01d8b587b0000000001","up":true},
				{"_id":"5316e01d8b587b0000000001","up":true},
				{"_id":"5326e01d8b587b0000000001","up":true},
				{"_id":"5336e01d8b587b0000000001","up":true},
				{"_id":"5346e01d8b587b0000000001","up":true},
				{"_id":"5356e01d8b587b0000000001","up":true},
				{"_id":"5366e01d8b587b0000000001","up":true},
				{"_id":"5376e01d8b587b0000000001","up":true},
				{"_id":"5386e01d8b587b0000000002","up":true},
				{"_id":"5396e01d8b587b0000000002","up":true},
				{"_id":"53a6e01d8b587b0000000001","up":true},
				{"_id":"53b6e01d8b587b0000000001","up":true}
			],
			"character":"5486e01d8b587b0000000001"
		},
		"opponent":{
			"username":"gezzoo_2",
			"_id":"52728fbf63a64c904c657ea6"
		},
		"board":{
			"_id":"5286fd942200ab0000000002",
			"name":"Bollywood",
			"characters":[
				"5386e01d8b587b0000000001",
				"5486e01d8b587b0000000001",
				"5586e01d8b587b0000000001",
				"5686e01d8b587b0000000001",
				"5786e01d8b587b0000000001",
				"5886e01d8b587b0000000001",
				"5986e01d8b587b0000000001",
				"5a86e01d8b587b0000000001",
				"5b86e01d8b587b0000000001",
				"5c86e01d8b587b0000000001",
				"5d86e01d8b587b0000000001",
				"5e86e01d8b587b0000000001",
				"5f86e01d8b587b0000000001",
				"5316e01d8b587b0000000001",
				"5326e01d8b587b0000000001",
				"5336e01d8b587b0000000001",
				"5346e01d8b587b0000000001",
				"5356e01d8b587b0000000001",
				"5366e01d8b587b0000000001",
				"5376e01d8b587b0000000001",
				"5386e01d8b587b0000000002",
				"5396e01d8b587b0000000002",
				"53a6e01d8b587b0000000001",
				"53b6e01d8b587b0000000001"
			]
		},
		"turn":"52728fbf63a64c904c657ed5",
		"ended":false,
		"modified":"2014-01-15T00:42:42.998Z"
	}];

	// $.getJSON('/api/games/5286e01d9beb41000b00003a?token=52728fbf63a64c904c657ed5', function(result){console.log(result)});
	var GAME = {
		"_id":"5286e01d9beb41000b00003a",
		"me": {
			"username":"gezzoo_1",
			"_id":"52728fbf63a64c904c657ed5",
			"board":[
				{"_id":"5386e01d8b587b0000000001","up":true},
				{"_id":"5486e01d8b587b0000000001","up":true},
				{"_id":"5586e01d8b587b0000000001","up":true},
				{"_id":"5686e01d8b587b0000000001","up":true},
				{"_id":"5786e01d8b587b0000000001","up":true},
				{"_id":"5886e01d8b587b0000000001","up":true},
				{"_id":"5986e01d8b587b0000000001","up":true},
				{"_id":"5a86e01d8b587b0000000001","up":true},
				{"_id":"5b86e01d8b587b0000000001","up":true},
				{"_id":"5c86e01d8b587b0000000001","up":true},
				{"_id":"5d86e01d8b587b0000000001","up":true},
				{"_id":"5e86e01d8b587b0000000001","up":true},
				{"_id":"5f86e01d8b587b0000000001","up":true},
				{"_id":"5316e01d8b587b0000000001","up":true},
				{"_id":"5326e01d8b587b0000000001","up":true},
				{"_id":"5336e01d8b587b0000000001","up":true},
				{"_id":"5346e01d8b587b0000000001","up":true},
				{"_id":"5356e01d8b587b0000000001","up":true},
				{"_id":"5366e01d8b587b0000000001","up":true},
				{"_id":"5376e01d8b587b0000000001","up":true},
				{"_id":"5386e01d8b587b0000000002","up":true},
				{"_id":"5396e01d8b587b0000000002","up":true},
				{"_id":"53a6e01d8b587b0000000001","up":true},
				{"_id":"53b6e01d8b587b0000000001","up":true}
			],
			"character":"5486e01d8b587b0000000001",
			"actions":[
				{
					"_id":"52d5d982a4be878f02000003",
					"gameid":"5286e01d9beb41000b00003a",
					"by":"52728fbf63a64c904c657ed5",
					"action":"question",
					"value":"Are you there?",
					"reply":{"value":"yes"},
					"modified":"2014-01-15T00:42:42.998Z"
				}
			]
		},
		"opponent":{
			"username":"gezzoo_2",
			"_id":"52728fbf63a64c904c657ea6",
			"actions":[
				{
					"_id":"52d5d982a4be878f02000001",
					"gameid":"5286e01d9beb41000b00003a",
					"by":"52728fbf63a64c904c657ea6",
					"action":"question",
					"value":"Are you there?",
					"modified":"2014-01-15T00:42:42.998Z"
				},
				{
					"_id":"52d5d982a4be878f02000002",
					"gameid":"5286e01d9beb41000b00003a",
					"by":"52728fbf63a64c904c657ea6",
					"action":"question",
					"value":"Are you there?",
					"reply":{"value":"yes"},
					"modified":"2014-01-15T00:42:42.998Z"
				}]
		},
		"board":{
			"name":"Bollywood",
			"characters":[
				{"_id":"5316e01d8b587b0000000001","name":"Katrina Kaif","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMTUwODY3NzA3NF5BMl5BanBnXkFtZTcwNTEzNDg3OA@@._V1_SY317_CR6,0,214,317_.jpg"},
				{"_id":"5326e01d8b587b0000000001","name":"Anushka Sharma","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMTc0NDMzMDYyM15BMl5BanBnXkFtZTcwMDEwMTA1NA@@._V1_SY317_CR104,0,214,317_.jpg"},
				{"_id":"5336e01d8b587b0000000001","name":"Priyanka Chopra","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMjAxNzUwNjExOV5BMl5BanBnXkFtZTcwNDUyMTUxNw@@._V1_SY317_CR105,0,214,317_.jpg"},
				{"_id":"5346e01d8b587b0000000001","name":"Aishwarya Rai","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMjEyMjEyODkzN15BMl5BanBnXkFtZTcwODkxMTY1Mg@@._V1_SX214_CR0,0,214,317_.jpg"},
				{"_id":"5356e01d8b587b0000000001","name":"Sonakshi Sinha","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BOTg3MzQxMTkwOF5BMl5BanBnXkFtZTcwNjcyOTM5NA@@._V1_SY317_CR18,0,214,317_.jpg"},
				{"_id":"5366e01d8b587b0000000001","name":"Vidya Balan","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BNDI3Mjk2MjgzMl5BMl5BanBnXkFtZTcwODQwMjI1OQ@@._V1_SY317_CR3,0,214,317_.jpg"},
				{"_id":"5376e01d8b587b0000000001","name":"Rani Mukerji","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMTg0MTI5MDkyMV5BMl5BanBnXkFtZTcwNzIyMDQ4Mg@@._V1_SY317_CR111,0,214,317_.jpg"},
				{"_id":"5386e01d8b587b0000000001","name":"Shah Rukh Khan","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMTQxMjg4Mzk1Nl5BMl5BanBnXkFtZTcwMzQyMTUxNw@@._V1_SY317_CR1,0,214,317_.jpg"},
				{"_id":"5386e01d8b587b0000000002","name":"Preity Zinta","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMTQyMDc4NTE1Ml5BMl5BanBnXkFtZTcwOTQwMDgxOA@@._V1_SX214_CR0,0,214,317_.jpg"},
				{"_id":"5396e01d8b587b0000000002","name":"Kajol","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BNzIyNDI1MTYwMV5BMl5BanBnXkFtZTcwNzg5MzcxMw@@._V1_SY317_CR131,0,214,317_.jpg"},
				{"_id":"53a6e01d8b587b0000000001","name":"Madhuri Dixit","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMjI1MTMxMDMxMV5BMl5BanBnXkFtZTcwMTUzNzY3Nw@@._V1_SY317_CR18,0,214,317_.jpg"},
				{"_id":"53b6e01d8b587b0000000001","name":"Juhi Chawla","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BNzI1MzUxODczNV5BMl5BanBnXkFtZTcwNDUyNTA0MQ@@._V1_SY317_CR12,0,214,317_.jpg"},
				{"_id":"5486e01d8b587b0000000001","name":"Arjun Rampal","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMTg0NTAzOTU4Ml5BMl5BanBnXkFtZTcwMzg1MjUyOA@@._V1_SX214_CR0,0,214,317_.jpg"},
				{"_id":"5586e01d8b587b0000000001","name":"Anupam Kher","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMTY0MDkxMzkwN15BMl5BanBnXkFtZTcwODUxNTA5Nw@@._V1_SX214_CR0,0,214,317_.jpg"},
				{"_id":"5686e01d8b587b0000000001","name":"Sanjay Dutt","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BNzU2NTgwNzY1OF5BMl5BanBnXkFtZTcwMjQxNzcxOA@@._V1_SY317_CR131,0,214,317_.jpg"},
				{"_id":"5786e01d8b587b0000000001","name":"Hrithik Roshan","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMTU1MjQzNDExN15BMl5BanBnXkFtZTcwNzIxMTg0Mw@@._V1_SY317_CR173,0,214,317_.jpg"},
				{"_id":"5886e01d8b587b0000000001","name":"Akshay Kumar","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMTU4NzM4Nzk1OF5BMl5BanBnXkFtZTcwMTAwMTA1NA@@._V1_SY317_CR104,0,214,317_.jpg"},
				{"_id":"5986e01d8b587b0000000001","name":"Salman Khan","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMTIyODQyOTA1M15BMl5BanBnXkFtZTcwMDQxNDIzMQ@@._V1_SY317_CR56,0,214,317_.jpg"},
				{"_id":"5a86e01d8b587b0000000001","name":"Ranveer Singh","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMTExOTcwMDU4NTReQTJeQWpwZ15BbWU3MDA0MjE1MTc@._V1_SY317_CR1,0,214,317_.jpg"},
				{"_id":"5b86e01d8b587b0000000001","name":"Emraan Hashmi","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMjExNzExNDY3OV5BMl5BanBnXkFtZTcwNzAyMTg2OA@@._V1_SY317_CR0,0,214,317_.jpg"},
				{"_id":"5c86e01d8b587b0000000001","name":"Amitabh Bachchan","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BNTk1OTUxMzIzMV5BMl5BanBnXkFtZTcwMzMxMjI0Nw@@._V1_SY317_CR8,0,214,317_.jpg"},
				{"_id":"5d86e01d8b587b0000000001","name":"Abhishek Bachchan","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMTk1NjU1NjkxN15BMl5BanBnXkFtZTcwNDI4MDMzMg@@._V1_SY317_CR10,0,214,317_.jpg"},
				{"_id":"5e86e01d8b587b0000000001","name":"John Abraham","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMTY1MDUyMjI1N15BMl5BanBnXkFtZTYwMjg4MjA0._V1_SX214_CR0,0,214,317_.jpg"},
				{"_id":"5f86e01d8b587b0000000001","name":"Deepika Padukone","category":["bollywood"],"img":"http://ia.media-imdb.com/images/M/MV5BMjAxMTAwMTY2MV5BMl5BanBnXkFtZTcwOTM5NTQyMg@@._V1_SX214_CR0,0,214,317_.jpg"}
			]
		},
		"ended":false,
		"turn":"52728fbf63a64c904c657ed5",
		"state":"ask-question",
		"modified":"2014-01-15T00:42:42.998Z"
	};

	var GameModel = function( game ) {
		return {
			getOpponentAvatar: function() {
				return 'http://placehold.it/64x64';
			},
			getOpponentName: function() {
				return game.opponent.username;
			},
			getAvatar: function() {
				return 'http://placehold.it/64x64';
			},
			getMostRecentAction: function() {
				// TODO: Sort the actions and get the most recent one.
				//		 You can maybe do this before the return statment.
				var actions = game.me.actions;
				if ( actions && actions.length > 0 ) {
					return actions[0];
				}

				return null;
			},
			getBoard: function() {
				var a = game.me.board.concat( game.board.characters );
				var b = _.reduce(a, function(m, item) {
					m[item._id] = ( m[item._id] ? _.extend(m[item._id], item) : item );
					return m; 
				}, {});

				return _.values(b);
			}
		};
	};

	var GameItemModel = function( game ) {
		return {
			getId: function() {
				return game._id;
			},
			getOpponentName: function() {
				return game.opponent.username;
			},
			getTurn: function() {
				var turn = game.turn === game.me._id;
				return turn ? "It's your turn" : "It's their turn";
			},
			getDate: function() {
				return moment(game.modified).fromNow();
			}
		};
	};

	function loadTemplateById(id) {
		return Handlebars.compile($(id).html());
	};

	function log(message) {
		console.log(message);
	};

	var templates = {
		gameitem: loadTemplateById('#game-item'),
		gamelist: loadTemplateById('#game-list'),
		board: loadTemplateById('#board'),
		question: loadTemplateById('#my-questions'),
		character_board: loadTemplateById('#character-board'),
		my_action: loadTemplateById('#my-action'),
		character_select: loadTemplateById('#character-select'),
		opponent_actions: loadTemplateById('#opponent-actions'),
		opponent_action: loadTemplateById('#opponent-action'),
		loading: loadTemplateById('#loading-view')
	};

	Handlebars.registerHelper('log', function(obj) {
		log(JSON.stringify(obj));
	});

	function renderQuestionAction( action, model ) {
		var data = {};

		if ( action && action.action === 'question' ) {
			data.me = {
				avatar: model.getAvatar(),
				value: action.value
			};
		}

		if ( action && action.reply ) {
			data.opponent = {
				name: model.getOpponentName(),
				avatar: model.getOpponentAvatar(),
				value: action.reply.value
			};
		}

		return templates.my_action(data);
	}

	function renderOpponentQuestionAction( action, model ) {
		var data = {};

		if ( action && action.action === 'question' ) {
			data.opponent = {
				name: model.getOpponentName(),
				avatar: model.getOpponentAvatar(),
				value: action.value
			};
		}

		if ( action && action.reply ) {
			data.me = {
				avatar: model.getAvatar(),
				value: action.reply.value
			};
		} else {
			data.enableInput = true;
		}

		return templates.opponent_action(data);
	}

	Handlebars.registerHelper('my_actions', function(game) {
		var model = new GameModel(game);
		var result = '';

		for ( var i in game.me.actions ) {
			var action = game.me.actions[i];

			if ( action.action === 'question' ) {
				result = result + renderQuestionAction( action, model );
			} else if ( action.action === 'guess' ) {

			}
		}

		return new Handlebars.SafeString( result );
	});

	Handlebars.registerHelper('last_action', function(game) {
		var model = new GameModel(game);
		var action = model.getMostRecentAction();

		return new Handlebars.SafeString(renderQuestionAction(action, model));
	});

	Handlebars.registerHelper('opponent_actions', function(game) {
		var model = new GameModel(game);
		var result = '';

		for ( var i in game.opponent.actions ) {
			var action = game.opponent.actions[i];

			if ( action.action === 'question' ) {
				result = result + renderOpponentQuestionAction( action, model );
			} else if ( action.action === 'guess' ) {

			}
		}

		return new Handlebars.SafeString( result );		
	});

	Handlebars.registerHelper('character_board', function(game) {
		var model = new GameModel( game );
		var result = templates.character_board({
			board: model.getBoard()
		});

		return new Handlebars.SafeString(result);
	});

	Handlebars.registerHelper('game_item', function(game) {
		var model = new GameItemModel( game );
		var result = templates.gameitem({
			id: model.getId(),
			username: model.getOpponentName(),
			turn: model.getTurn(),
			date: model.getDate()
		});

		return new Handlebars.SafeString(result);
	});

	var EventManager = {
	    subscribe: function(event, fn) {
	        $(this).bind(event, fn);
	    },
	    unsubscribe: function(event, fn) {
	        $(this).unbind(event, fn);
	    },
	    publish: function(event) {
	        $(this).trigger(event);
	    }
	};

	var Application = function( $el ) {
		this.$el = $el;
		this.currentView = null;
		var me = this;

		return {
			switchViews: function( view ) {
				if ( me.currentView ) {
					var c = me.currentView.clicks();
					for ( i in c ) {
						$(i).off( 'click', c[i] );
					}
				}

				me.$el.html(view.render());

				var c = view.clicks();
				for ( i in c ) {
					$(i).on( 'click', c[i] );
				}

				me.currentView = view;
			}
		};
	};

	var View = function( template, options ) {
		this.data = null;
		this.template = template;
		this.click = _.extend(options.click, {});
		var me = this;

		return {
			clicks: function() {
				return me.click;
			},
			set: function( data ) {
				me.data = data;
			},
			get: function() {
				return me.data;
			},
			render: function() {
				return me.template( this.get() );
			}
		}
	};

	var gamelist = new View(templates.gamelist, {
		click: {
			'.character-game-item': function( e ) {
				console.log(e);
			}
		}
	});

	var board = new View(templates.board, {
		click: {

		}
	});

	var questions = new View(templates.question, {
		click: {
			
		}
	});

	var character_select = new View(templates.character_select, {
		click: {

		}
	});

	var opponent_actions = new View(templates.opponent_actions, {
		click: {

		}
	});

	var application = new Application($('#main'));
	EventManager.subscribe('switchView', function( data ) {

	});

	gamelist.set( GAMES );
	application.switchViews( gamelist );
})();
